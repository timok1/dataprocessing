<!DOCTYPE html>
<!-- Timo Koster, 10815716 -->

<html>
  <head>
    <title>Sea Ice Graph</title>
  </head>
  <script>
    var fileName = "converted_data.json";
    var txtFile = new XMLHttpRequest();
    txtFile.onreadystatechange = function() {
        if (txtFile.readyState === 4 && txtFile.status == 200) {
            console.log(JSON.parse(txtFile.responseText));

            var data = JSON.parse(txtFile.responseText);
            var days = Object.keys(data);
            var iceExtent = [];
            var iceExtentTransform = [];
            var daysTransform = [];
            var graphLinesArray = [];
            var graphLinesArrayTransform = [];
            var graphWidth = 700;
            var graphHeight = 450;
            var valueHeight = 20;
            var totalDays = days.length;
            var xOffset = 50
            var yOffset = 40
            var monthsJson =  {'Jan':31, 'Feb':28, 'Mar':31,'Apr':30,'May':31,'Jun':30,'Jul':31, 'Aug':31, 'Sep':30,'Oct':31,'Nov':30,'Dec':31};
            var monthNames = Object.keys(monthsJson);
            var cumulativeDays = 0;

            for (let month of monthNames) {
              cumulativeDays = cumulativeDays += monthsJson[month];
              monthsJson[month] = createTransform([0, totalDays], [xOffset, graphWidth])(cumulativeDays);
            }
            console.log(monthsJson)


            for (let i = 0; i <= valueHeight; i += 2) {
              graphLinesArray.push(i);
              graphLinesArrayTransform.push(createTransform([0, valueHeight], [yOffset, graphHeight])(i));
            }

            for (let i of days) {
              iceExtent.push(data[i]['Average Extent']);
              daysTransform.push(createTransform([0, totalDays], [xOffset, graphWidth])(i));
            }

            for (let i of iceExtent) {
              iceExtentTransform.push(createTransform([0, valueHeight], [yOffset, graphHeight])(i));
            }



            function draw() {
              var canvas = document.getElementById('graph');
              if (canvas.getContext) {
                var ctx = canvas.getContext('2d');

                function drawLine() {
                  ctx.beginPath();
                  ctx.lineWidth = 3;
                  ctx.strokeStyle = '#0000FF'
                  ctx.moveTo(daysTransform[0], canvas.height - iceExtentTransform[0])
                  for (let i of days) {
                    ctx.lineTo(daysTransform[i], canvas.height - iceExtentTransform[i])
                  }
                  ctx.stroke();
                }

                function drawGraphEdges() {
                  ctx.beginPath();
                  ctx.lineWidth = 2;
                  ctx.strokeStyle = '#808080'
                  ctx.moveTo(xOffset, 0);
                  ctx.lineTo(xOffset, canvas.height - yOffset);
                  ctx.lineTo(canvas.width, canvas.height - yOffset);
                  ctx.lineTo(canvas.width, 0);
                  ctx.lineTo(xOffset, 0);
                  ctx.stroke();
                }

                function yTicks() {}
                  ctx.beginPath();
                  ctx.lineWidth = 1;
                  ctx.strokeStyle = '#808080'
                  ctx.font = "11px Arial";
                  var i = 0;
                  for (let line of graphLinesArrayTransform) {
                    ctx.moveTo(xOffset, canvas.height - line);
                    ctx.lineTo(canvas.width, canvas.height - line);
                    ctx.fillText(graphLinesArray[i], xOffset - 20, canvas.height - line + 8);
                    i++;
                  }

                  ctx.stroke();
                }

                function yLabel() {
                  ctx.font = "15px Arial";
                  ctx.save();
                  ctx.translate(canvas.width, 0);
                  ctx.rotate(1.5*Math.PI);
                  ctx.textAlign = "right";
                  ctx.fillText('Area of sea ice (million km\u00B2)', -100, -canvas.width + 15);
                  ctx.stroke();
                  ctx.restore();
                }

                function xLabel() {
                  ctx.font = "15px Arial";
                  ctx.fillText('Month', canvas.width/2, canvas.height);
                }

                function xTicks() {
                  var tickLocX = xOffset;
                  var tickLocY = canvas.height - yOffset;
                  ctx.lineWidth = 1;
                  ctx.strokeStyle = '#808080';
                  ctx.font = "12px Arial";

                  for (let month of monthNames) {
                    ctx.fillText(month + ' 1', tickLocX - 10, tickLocY + 13);
                    ctx.moveTo(tickLocX, tickLocY);
                    ctx.lineTo(tickLocX, 0);
                    tickLocX = monthsJson[month]
                  }
                  ctx.stroke();
                }

                yTicks();
                drawGraphEdges();
                yLabel();
                xLabel();
                xTicks();
                drawLine();
              }

              draw();

        }
    }
    txtFile.open("GET", fileName);
    txtFile.send();

    function createTransform(domain, range){
    	// domain is a two-element array of the data bounds [domain_min, domain_max]
    	// range is a two-element array of the screen bounds [range_min, range_max]
    	// this gives you two equations to solve:
    	// range_min = alpha * domain_min + beta
    	// range_max = alpha * domain_max + beta
     		// a solution would be:

      var domain_min = domain[0]
      var domain_max = domain[1]
      var range_min = range[0]
      var range_max = range[1]

      // formulas to calculate the alpha and the beta
     	var alpha = (range_max - range_min) / (domain_max - domain_min)
      var beta = range_max - alpha * domain_max

      // returns the function for the linear transformation (y= a * x + b)
      return function(x){
        return alpha * x + beta;
          }
      }


  </script>
  <body>
    <h3>Average amount of sea ice in the northern hemisphere by day of the year (1981-2010)</h3>
    <canvas id="graph" width="700" height="450" border=1px ></canvas>
  </body>
</html>
